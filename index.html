<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ubicaci√≥n en Ruta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #mensaje { padding: 10px; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <div id="mensaje">üîç Verificando ubicaci√≥n...</div>
  <div id="map"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const socket = io();
    const map = L.map('map').setView([LAT_INICIAL, LNG_INICIAL], 16); // <- ajusta estas coords
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const mensaje = document.getElementById("mensaje");

    // Ruta predefinida
    const ruta = [
      [LAT1, LNG1],
      [LAT2, LNG2],
      [LAT3, LNG3]
    ]; // <- tus coordenadas de la ruta aqu√≠

    ruta.forEach(coord => {
      L.circle(coord, { radius: 30, color: 'blue', fillOpacity: 0.1 }).addTo(map);
    });

    function calcularDistancia(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLng = (lng2 - lng1) * rad;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function verificarCercania(lat, lng) {
      let distanciaMinima = Infinity;

      ruta.forEach(coord => {
        const dist = calcularDistancia(lat, lng, coord[0], coord[1]);
        if (dist < distanciaMinima) {
          distanciaMinima = dist;
        }
      });

      if (distanciaMinima <= 30) {
        mensaje.innerText = "‚úÖ Que tenga un buen viaje";
        mensaje.style.background = "#d4edda";
        mensaje.style.color = "#155724";
      } else {
        mensaje.innerText = "üö® Usted est√° fuera de la ruta indicada";
        mensaje.style.background = "#f8d7da";
        mensaje.style.color = "#721c24";
      }
    }

    let marcadorUsuario;
    const marcadoresOtros = {};

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (!marcadorUsuario) {
            marcadorUsuario = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map).bindPopup("¬°Est√°s aqu√≠!").openPopup();
          } else {
            marcadorUsuario.setLatLng([lat, lng]);
          }

          socket.emit('ubicacion', { lat, lng });

          verificarCercania(lat, lng);
        },
        err => {
          mensaje.innerText = "‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n: " + err.message;
          mensaje.style.background = "#ffeeba";
          mensaje.style.color = "#856404";
        },
        { enableHighAccuracy: true }
      );
    } else {
      mensaje.innerText = "‚ùå Tu navegador no soporta geolocalizaci√≥n.";
    }

    // Recibir ubicaciones de otros usuarios
    socket.on('nueva-ubicacion', data => {
      const id = data.id;
      const lat = data.lat;
      const lng = data.lng;

      if (id === socket.id) return;

      if (!marcadoresOtros[id]) {
        marcadoresOtros[id] = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map).bindPopup("Otro usuario");
      } else {
        marcadoresOtros[id].setLatLng([lat, lng]);
      }
    });
  </script>
</body>
</html>


