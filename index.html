<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruta por Calles con Paradas + Ubicación</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const apiKey = 'TU_API_KEY_AQUI'; // ← Coloca aquí tu API Key de OpenRouteService

    const map = L.map('map').setView([-16.5, -68.15], 13);

    // Mapa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Puntos de parada
    const puntosRuta = [
      { lat: -16.504157, lng: -68.121039, nombre: "Plz. Triangular (Inicio)" },
      { lat: -16.519312, lng: -68.116206, nombre: "Curva de Olguin (Parada 1)" },
      { lat: -16.521485, lng: -68.110673, nombre: "Alto Obrajes (Parada 2)" },
      { lat: -16.537941, lng: -68.087285, nombre: "Teleferico verde (Parada 3)" },
      { lat: -16.534834, lng: -68.086801, nombre: "Teleferico verde (Destino)" }
    ];

    // Dibujar marcadores
    puntosRuta.forEach(p => {
      L.marker([p.lat, p.lng])
        .addTo(map)
        .bindPopup(p.nombre);
    });

    // Obtener coordenadas para la ruta
    const coords = puntosRuta.map(p => [p.lng, p.lat]); // ORS espera [lng, lat]

    // Solicitud a OpenRouteService
    fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: {
        "Authorization": apiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        coordinates: coords
      })
    })
    .then(res => res.json())
    .then(data => {
      const ruta = L.geoJSON(data, {
        style: { color: "blue", weight: 4 }
      }).addTo(map);
      map.fitBounds(ruta.getBounds());
    })
    .catch(err => {
      console.error(err);
      alert("Error al trazar la ruta: " + err.message);
    });

    // OPCIONAL: Ubicación del usuario en tiempo real
    let marcadorUsuario = null;

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (!marcadorUsuario) {
            marcadorUsuario = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map).bindPopup("¡Estás aquí!").openPopup();
          } else {
            marcadorUsuario.setLatLng([lat, lng]);
          }
        },
        (err) => {
          console.warn("Ubicación no disponible: " + err.message);
        },
        { enableHighAccuracy: true }
      );
    }
  </script>
</body>
</html>


